# 多机数据库的实现

### 1. 复制

#### 1.1 旧版复制功能的实现

分为同步（sync）和命令传播（command propagate）。

* 同步操作用于将从服务器的数据库状态更新至主服务器当前所处的数据库状态。
* 命令传播则用于在主服务器的数据库状态被修改，导致主从服务器的数据库状态出现不一致时，让主从服务器的数据库重新回到一致状态。

##### 1.1.1 同步

1. 从服务器向主服务器发送sync命令。
2. 收到sync命令的主服务器执行BGSAVE命令，在后台生成一个RDB文件，并使用一个缓冲区记录从现在开始执行的所有写命令。
3. 当主服务器的BGSAVE命令执行完毕时，主服务器会将BGSAVE命令生成的RDB文件发送给从服务器，从服务器接收并载入这个RDB文件，将自己的数据库状态更新至主服务器执行BGSAVE命令时的数据库状态。
4. 主服务器将记录在缓冲区里面的所有写命令发送给从服务器，从服务器执行这些写命令，将自己的数据库状态更新至主服务器数据库当前所处的状态。

##### 1.1.2 命令传播

#### 1.2 旧版复制功能的缺陷

1. 初次复制：从服务器以前没有复制过任何主服务器，或者从服务器当前要复制的主服务器和上一次复制的主服务器不同。
2. 断线后重复制：处于命令传播阶段的主从服务器因为网路原因而中断了复制，但从服务器通过自动重连接重新连上了主服务器，并继续复制主服务器。

#### 1.3 新版复制功能的实现

psync命令代替sync命令来执行复制时的同步操作

psync命令具有完整重同步和部分重同步两种模式：

1. 完整重同步用于初次复制
2. 部分重同步用于处理断线后重复制

#### 1.4 部分重同步的实现

部分重同步功能由以下三个部分构成：

* 主服务器的复制偏移量和从服务器的复制偏移量
* 主服务器的复制积压缓冲区
* 服务器的运行ID

主从服务器会分别维护一个复制偏移量：

* 主服务器每次向从服务器传播N个字节的数据时，就将自己的复制偏移量的值加上N。
* 从服务器每次收到主服务器传播来的N个字节的数据时，就将自己的复制偏移量的值加上N。

复制积压缓冲区是由主服务器维护的一个固定长度、先进先出队列，默认大小为1MB。

当从服务器重新连上主服务器时，从服务器会通过psync命令将自己的复制偏移量offset发送给主服务器，主服务器会根据这个复制偏移量来决定对从服务器执行何种同步操作：

1. 如果offset偏移量之后的数据仍然存在与复制积压缓冲区里面，那么主服务器将对从服务器执行部分重同步操作。
2. 相反，如果offset偏移量之后的数据已经不存在于复制挤压缓冲区，那么主服务器将对从服务器执行完整重同步操作。

服务器运行ID用于判断当前连接的主服务器是否为之前的主服务器，以此来决定是否进行完整重同步还是部分重同步。

![](C:\Users\silverspoon\Documents\note\redis\fsync操作.png)

##### 心跳检测

在命令传播阶段，从服务器默认会以每秒一次的频率向主服务器发送命令：

REPLCONF ACK <replication_offset>

replication_offset是从服务器当前的复制偏移量。

发送REPLCONF ACK命令有三个作用：

1. 检测主从服务器的网络连接状态。
2. 辅助实现min-slaves选项。
3. 检测命令丢失。

### 2. Sentinel

Sentinel（哨岗、哨兵）是Redis的高可用性解决方案：由一个或多个Sentinel实例组成的Sentinel系统可以监视任意多个主服务器，以及这些主服务器属下的所有从服务器，并在被监视的主服务器进入下线状态时，自动将下线主服务器属下的某个从服务器升级为新的主服务器，然后由新的主服务器代替已下线的主服务器继续处理命令请求。